<div class="h-full flex flex-col">
  <!-- Feature Selector -->
  <header class="flex-shrink-0 p-3 md:p-4 border-b border-input/50 overflow-hidden bg-secondary/30">
    <div class="flex items-center gap-2 overflow-x-auto pb-3 -mb-3">
      @for (feature of features; track feature.id) {
        <button (click)="selectFeature(feature.id)"
                [class.bg-accent]="selectedFeatureId() === feature.id"
                [class.text-white]="selectedFeatureId() === feature.id"
                [class.bg-input/50]="selectedFeatureId() !== feature.id"
                [class.hover:bg-input]="selectedFeatureId() !== feature.id"
                class="flex-shrink-0 flex items-center gap-2 px-3.5 py-2 rounded-lg text-sm font-medium transition-colors">
          <span [innerHTML]="feature.icon"></span>
          <span>{{ feature.name }}</span>
        </button>
      }
    </div>
  </header>

  <!-- Chat Messages -->
  <div #chatContainer class="flex-1 overflow-y-auto p-4 md:p-6 space-y-6">
    @if (!filteredMessages().length) {
      <div class="flex flex-col items-center justify-center h-full text-text-secondary text-center p-4 animate-fade-in-up">
        <div class="w-20 h-20 bg-secondary rounded-2xl flex items-center justify-center mb-6 shadow-lg text-4xl" [innerHTML]="currentFeature()?.icon"></div>
        <h2 class="text-2xl font-bold text-text-primary">AI {{ currentFeature()?.name }}</h2>
        <p class="mt-2 max-w-md">{{ currentFeature()?.systemInstruction }}</p>

        <div class="mt-8 w-full max-w-md">
            <h3 class="text-sm font-medium text-text-secondary mb-3">Try an example:</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-left">
                @for(example of currentFeature()?.examples; track example) {
                    <button (click)="useExample(example)" class="p-3 bg-input/50 hover:bg-input rounded-lg text-sm text-text-primary transition-colors text-left">
                        {{ example }}
                    </button>
                }
            </div>
        </div>
      </div>
    } @else {
      @for (message of filteredMessages(); track message.id) {
        <div class="flex gap-3 animate-fade-in-up" [class.flex-row-reverse]="message.role === 'user'">
          <div class="w-8 h-8 rounded-full flex-shrink-0" [class.bg-gradient-to-br]="message.role === 'user'" [class.from-highlight]="message.role === 'user'" [class.to-accent]="message.role === 'user'" [class.bg-input]="message.role === 'model'"></div>
          <div class="max-w-[85%] sm:max-w-xl">
            <div class="px-4 py-3 rounded-lg" 
                 [class.bg-gradient-to-br]="message.role === 'user'" 
                 [class.from-accent]="message.role === 'user'" 
                 [class.to-highlight]="message.role === 'user'" 
                 [class.text-white]="message.role === 'user'" 
                 [class.shadow-lg]="message.role === 'user'"
                 [class.bg-input]="message.role === 'model'">
              @if (message.isLoading && !message.text) {
                <div class="flex items-center gap-2">
                  <div class="h-2 w-2 bg-text-secondary rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                  <div class="h-2 w-2 bg-text-secondary rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                  <div class="h-2 w-2 bg-text-secondary rounded-full animate-pulse"></div>
                </div>
              } @else if (message.error) {
                <p class="text-red-400 font-medium text-sm">{{ message.error }}</p>
              } @else {
                <div class="prose prose-sm prose-invert max-w-none" [innerHTML]="message.text"></div>
              }
            </div>
            @if (message.sources && message.sources.length > 0) {
              <div class="mt-3">
                <h4 class="text-xs font-semibold text-text-secondary mb-1.5">Sources:</h4>
                <div class="flex flex-wrap gap-2">
                  @for (source of message.sources; track source.uri) {
                    <a [href]="source.uri" target="_blank" class="bg-input/50 hover:bg-input text-text-secondary text-xs px-2 py-1 rounded-md transition-colors">
                      {{ source.title }}
                    </a>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- User Input -->
  <div class="flex-shrink-0 p-4 bg-primary/80 border-t border-input/50 backdrop-blur-sm">
    @if (isLoading()) {
      <div class="flex justify-center mb-2">
        <button (click)="stopGeneration()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-md text-sm font-medium transition-colors flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M5 3.25a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 .75.75v9.5a.75.75 0 0 1-.75-.75h-4.5a.75.75 0 0 1-.75-.75V3.25Z" /></svg>
          Stop
        </button>
      </div>
    }
    <div class="max-w-3xl mx-auto bg-input/50 rounded-xl p-2 flex items-end gap-2 ring-1 ring-input focus-within:ring-2 focus-within:ring-accent transition-shadow">
      <textarea #userInputElement
                [(ngModel)]="userInput"
                (keydown)="handleKeydown($event)"
                (input)="adjustTextareaHeight($event)"
                rows="1"
                class="flex-1 bg-transparent p-2 outline-none text-sm resize-none"
                [placeholder]="isListening() ? 'Listening...' : (currentFeature()?.placeholder || 'Enter your message...')"
                [disabled]="isLoading() || isListening()"></textarea>
      
      @if (speechRecognitionSupported()) {
        <button (click)="toggleVoiceInput()" [disabled]="isLoading()" 
                [class.text-red-500]="isListening()"
                [class.animate-pulse]="isListening()"
                class="text-text-secondary rounded-lg p-2 disabled:opacity-50 disabled:cursor-not-allowed hover:text-highlight transition-colors">
          @if (isListening()) {
            <!-- Stop Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M5.25 5.25a.75.75 0 0 0-.75.75v8a.75.75 0 0 0 .75.75h8a.75.75 0 0 0 .75-.75v-8a.75.75 0 0 0-.75-.75h-8Z" />
            </svg>
          } @else {
            <!-- Microphone Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" />
              <path d="M5.5 4.5A.5.5 0 016 4h8a.5.5 0 01.5.5v5a.5.5 0 01-.5.5H6a.5.5 0 01-.5-.5v-5zM3.5 10a.5.5 0 000 1h13a.5.5 0 000-1h-13z" />
              <path d="M10 13a2.5 2.5 0 00-2.5 2.5V17a.5.5 0 00.5.5h4a.5.5 0 00.5-.5v-1.5A2.5 2.5 0 0010 13z" />
            </svg>
          }
        </button>
      }

      <button (click)="sendMessage()" [disabled]="isLoading() || !userInput().trim()" class="bg-accent rounded-lg p-2 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-highlight transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M3.105 3.105a.75.75 0 0 1 .814-.158l12.685 4.886a.75.75 0 0 1 0 1.332L3.92 14.053a.75.75 0 0 1-.976-.976l2.31-4.991-2.31-4.99a.75.75 0 0 1 .158-.814Z" /></svg>
      </button>
    </div>
  </div>
</div>